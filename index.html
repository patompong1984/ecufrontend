<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>ECU Map Analyzer & Tuner</title>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background-color: #f6f6f6; color: #333; }
    h2 { margin-bottom: 15px; color: #2a6496; }
    form, .controls {
      background-color: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      margin-bottom: 20px;
      display: flex;
      flex-wrap: wrap; /* Allow items to wrap on smaller screens */
      gap: 10px; /* Space between form elements */
      align-items: center;
    }
    label { font-weight: bold; margin-right: 5px; }
    select, input[type="file"], button {
      padding: 10px 15px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 16px;
      flex-grow: 1; /* Allow elements to grow */
      min-width: 150px; /* Minimum width for responsiveness */
    }
    button {
      background-color: #4CAF50;
      color: white;
      cursor: pointer;
      border: none;
      transition: background-color 0.3s ease;
    }
    button:hover { background-color: #45a049; }
    button:disabled { background-color: #cccccc; cursor: not-allowed; }

    #glossary {
      margin-top: 10px;
      font-style: italic;
      color: #555;
      background-color: #e9e9e9;
      padding: 10px;
      border-radius: 5px;
    }
    #mapChart { margin-top: 30px; border: 1px solid #eee; border-radius: 8px; overflow: hidden; }

    /* Table styling for editing */
    #editableMapTableContainer {
      margin-top: 20px;
      overflow-x: auto; /* Enable horizontal scrolling for large tables */
      max-width: 100%; /* Ensure container respects parent width */
    }
    #editableMapTable {
      width: 100%; /* Use 100% width for table */
      border-collapse: collapse;
      font-size: 14px;
      text-align: center;
      min-width: 600px; /* Ensure table is wide enough for editing */
    }
    #editableMapTable th, #editableMapTable td {
      border: 1px solid #ccc;
      padding: 8px 5px;
      white-space: nowrap; /* Prevent wrapping in cells */
    }
    #editableMapTable th {
      background-color: #e0e0e0;
      font-weight: bold;
    }
    #editableMapTable td {
      background-color: #fff;
    }
    #editableMapTable td[contenteditable="true"]:focus {
      background-color: #eaf6ff;
      outline: 2px solid #2a6496;
    }
    #editableMapTable td[contenteditable="true"]:hover {
      background-color: #f5f5f5;
    }
    .axis-label {
        font-weight: bold;
        background-color: #f0f0f0;
    }
    .loading-spinner {
        display: none;
        border: 4px solid #f3f3f3;
        border-top: 4px solid #3498db;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        animation: spin 1s linear infinite;
        margin-left: 10px;
    }
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    /* Controls for 2D Plot */
    #linePlotControls {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-top: 15px;
        align-items: center;
        background-color: #f0f0f0;
        padding: 10px;
        border-radius: 5px;
    }
    #linePlotControls label {
        font-weight: normal;
        margin-right: 0;
    }
    #linePlotControls input[type="range"] {
        flex-grow: 1;
        min-width: 100px;
    }
    /* Mobile-specific adjustments */
    @media (max-width: 600px) {
      form, .controls, #linePlotControls {
        flex-direction: column;
        align-items: stretch;
      }
      select, input[type="file"], button, #linePlotControls input[type="range"] {
        width: 100%;
        min-width: unset;
      }
      #editableMapTable {
        font-size: 12px;
        min-width: unset; /* Allow table to shrink on small screens */
      }
      #editableMapTable th, #editableMapTable td {
        padding: 5px 3px;
      }
    }
  </style>
</head>
<body>
  <h2>ECU Map Analyzer & Tuner</h2>
  <form id="uploadForm">
    <label for="mapType">เลือกแผนที่:</label>
    <select id="mapType" onchange="showGlossary(this.value)">
      <option value="limit_iq_1">Limit IQ #1</option>
      <option value="limit_iq_2">Limit IQ #2</option>
      <option value="limit_iq_3">Limit IQ #3</option>
      <option value="torque_tps_1">Torque TPS #1</option>
      <option value="torque_tps_2">Torque TPS #2</option>
      <option value="torque_tps_3">Torque TPS #3</option>
      <option value="egr_target">EGR Target</option>
      <option value="pump_command">Pump Command</option>
      <option value="injector_1">Injector #1</option>
      <option value="injector_2">Injector #2</option>
      <option value="limit_baro_1">Limit BARO 1</option>
      <option value="limit_baro_2">Limit BARO 2</option>
      <option value="limit_baro_3">Limit BARO 3</option>
      <option value="limit_torque">Limit Torque</option>
      <option value="torque_gear">Torque Gear</option>
      <option value="limit_crp">Limit CRP</option>
      <option value="green_1">Green Zone #1</option>
      <option value="green_2">Green Zone #2</option>
      <option value="green_3">Green Zone #3</option>
      <option value="green_4">Green Zone #4</option>
      <option value="green_5">Green Zone #5</option>
      <option value="turbo">Turbo Target</option>
      <option value="turbo_meter">Turbo Meter</option>
      <option value="dtc_off">DTC Table</option>
    </select>
    <input type="file" id="binFile" accept=".bin" required />
    <button type="submit" id="analyzeButton">วิเคราะห์แผนที่</button>
    <div class="loading-spinner" id="loadingSpinner"></div>
  </form>

  <div id="glossary">คำอธิบายแผนที่จะปรากฏที่นี่</div>

  <div id="mapDisplayArea">
    <div id="mapChart"></div>
    <div id="editableMapTableContainer"></div>
    <div id="linePlotControls" style="display: none;">
        <label for="linePlotAxis">เลือกแกน:</label>
        <select id="linePlotAxis">
            <option value="y">ตามแนวแกน Y (RPM)</option>
            <option value="x">ตามแนวแกน X (LOAD)</option>
        </select>
        <label for="linePlotIndex">เลือก Index:</label>
        <input type="range" id="linePlotIndex" min="0" value="0">
        <span id="currentLinePlotIndex">0</span>
    </div>
  </div>

  <div class="controls" id="tuningControls" style="display: none;">
    <button id="saveMapButton">บันทึกค่าที่จูน (ดาวน์โหลดไฟล์)</button>
    <button id="showSurfacePlotButton">แสดงกราฟ 3D</button>
    <button id="showLinePlotButton" style="display: none;">แสดงกราฟ 2D</button>
    <button id="showTableButton" style="display: none;">แสดงตาราง</button>
  </div>

  <script>
const glossary = {
  limit_iq_1: "ปริมาณเชื้อเพลิงต่อรอบที่ ECU จำกัดไว้",
  limit_iq_2: "แมพซ้ำสำหรับสถานการณ์ต่างกัน",
  limit_crp: "แรงดันน้ำมันในรางแรงดันสูง",
  torque_tps_1: "คำสั่งแรงบิดจากคันเร่ง",
  injector_1: "แมพการฉีดน้ำมัน",
  dtc_off: "ตารางปิดรหัสแจ้งเตือน DTC",
  egr_target: "ระดับการหมุนเวียนไอเสียที่ต้องการ",
  green_1: "Green Zone #1 - ค่า boost/fuel zone",
  turbo: "Turbo target: ระดับแรงดันเทอร์โบที่สั่งงาน"
};

function showGlossary(type) {
  document.getElementById("glossary").innerText = glossary[type] || "ไม่มีคำอธิบายสำหรับแผนที่นี้";
}

// Global variables to store current map data and file
let currentMapData = null; // Stores parsed map data from backend
let currentBinFile = null; // Stores the original uploaded .bin file
let currentMapInfo = null; // Stores map metadata (type, unit, offset, x_axis, y_axis)

const analyzeButton = document.getElementById("analyzeButton");
const saveMapButton = document.getElementById("saveMapButton");
const showSurfacePlotButton = document.getElementById("showSurfacePlotButton");
const showLinePlotButton = document.getElementById("showLinePlotButton"); // New button for 2D plot
const showTableButton = document.getElementById("showTableButton");
const loadingSpinner = document.getElementById("loadingSpinner");
const mapChartDiv = document.getElementById("mapChart");
const editableMapTableContainer = document.getElementById("editableMapTableContainer");
const tuningControls = document.getElementById("tuningControls");
const linePlotControls = document.getElementById("linePlotControls"); // New controls div for 2D plot
const linePlotAxisSelect = document.getElementById("linePlotAxis");
const linePlotIndexSlider = document.getElementById("linePlotIndex");
const currentLinePlotIndexSpan = document.getElementById("currentLinePlotIndex");


// Function to show/hide elements
function showElement(element) { element.style.display = 'flex'; } // Using flex for buttons row
function hideElement(element) { element.style.display = 'none'; }

// Initial state
hideElement(tuningControls);
hideElement(editableMapTableContainer); // Initially hide table
hideElement(linePlotControls); // Initially hide 2D plot controls

document.getElementById("uploadForm").addEventListener("submit", async function (e) {
  e.preventDefault();
  analyzeButton.disabled = true;
  saveMapButton.disabled = true; // Disable save button during analysis
  showElement(loadingSpinner);
  hideElement(tuningControls); // Hide controls until data is ready
  hideElement(linePlotControls); // Hide 2D plot controls

  const fileInput = document.getElementById("binFile");
  const mapType = document.getElementById("mapType").value;
  const file = fileInput.files[0];
  currentBinFile = file; // Store the original file

  if (!file) {
    alert("❌ กรุณาเลือกไฟล์ .bin");
    analyzeButton.disabled = false;
    hideElement(loadingSpinner);
    return;
  }

  const formData = new FormData();
  formData.append("bin", file);
  formData.append("type", mapType);

  try {
    const res = await fetch("https://ecu-backend-m07d.onrender.com/analyze", {
      method: "POST",
      body: formData
    });
    const data = await res.json();

    if (data.error) {
      alert("❌ Backend error: " + data.error);
      return;
    }
    if (!data.map || !Array.isArray(data.map) || data.map.length === 0 || !Array.isArray(data.map[0])) {
      alert("❌ ไม่พบข้อมูลแผนที่ หรือข้อมูลแผนที่ผิดปกติ");
      return;
    }

    currentMapData = data.map; // Store the parsed map data
    currentMapInfo = { // Store other relevant info
        type: data.type,
        display_name: data.display_name,
        offset: data.offset,
        x_axis: data.x_axis,
        y_axis: data.y_axis,
        unit: data.unit
    };

    // Initialize slider max values
    linePlotIndexSlider.max = (linePlotAxisSelect.value === 'y' ? currentMapData.length : currentMapData[0].length) - 1;
    linePlotIndexSlider.value = 0; // Reset slider to 0
    currentLinePlotIndexSpan.innerText = 0; // Update span

    // Show initial view (Surface Plot)
    renderSurfacePlot();
    showElement(tuningControls); // Show tuning controls after successful analysis
    saveMapButton.disabled = false; // Enable save button
    showTableButton.style.display = 'none'; // Initially hide table button if plot is shown
    showSurfacePlotButton.style.display = 'block'; // Ensure plot button is visible
    showLinePlotButton.style.display = 'block'; // Show 2D plot button

  } catch (err) {
    console.error("Fetch Error:", err);
    alert("เกิดข้อผิดพลาดในการวิเคราะห์ไฟล์: " + err.message);
  } finally {
    analyzeButton.disabled = false;
    hideElement(loadingSpinner);
  }
});

// Function to render Plotly Surface Plot
function renderSurfacePlot() {
    if (!currentMapData || !currentMapInfo) return;

    // Show Plotly, hide table, hide 2D controls
    showElement(mapChartDiv);
    hideElement(editableMapTableContainer);
    hideElement(linePlotControls);
    
    showElement(showTableButton); // Now user can switch to table
    showElement(showLinePlotButton); // Now user can switch to 2D plot
    hideElement(showSurfacePlotButton); // Hide surface plot button when it's already shown

    Plotly.newPlot("mapChart", [{
      z: currentMapData,
      x: currentMapInfo.x_axis,
      y: currentMapInfo.y_axis,
      type: "surface",
      colorscale: "Jet",
      hovertemplate: `LOAD: %{x}<br>RPM: %{y}<br>ค่า: %{z} ${currentMapInfo.unit || ""}<extra></extra>`
    }], {
      title: `${currentMapInfo.display_name} (${currentMapInfo.unit || "?"})`,
      scene: {
        xaxis: { title: "LOAD" },
        yaxis: { title: "RPM" },
        zaxis: { title: currentMapInfo.unit || "Value" }
      },
      autosize: true,
      margin: { l: 0, r: 0, b: 0, t: 50 },
      height: 500
    }, { responsive: true });
}

// Function to render Editable Table
function renderEditableTable() {
    if (!currentMapData || !currentMapInfo) return;

    // Hide Plotly, show table, hide 2D controls
    hideElement(mapChartDiv);
    showElement(editableMapTableContainer);
    hideElement(linePlotControls);

    showElement(showSurfacePlotButton); // Now user can switch to plot
    showElement(showLinePlotButton); // Now user can switch to 2D plot
    hideElement(showTableButton); // Hide table button when table is shown

    let tableHTML = `<table id="editableMapTable"><thead><tr><th class="axis-label">Y\\X</th>`;
    // X-axis headers
    currentMapInfo.x_axis.forEach(x => {
        tableHTML += `<th class="axis-label">${x !== null ? x.toFixed(2) : ''}</th>`;
    });
    tableHTML += `</tr></thead><tbody>`;

    // Map data rows
    currentMapData.forEach((row, rowIndex) => {
        tableHTML += `<tr><td class="axis-label">${currentMapInfo.y_axis[rowIndex] !== null ? currentMapInfo.y_axis[rowIndex].toFixed(2) : ''}</td>`;
        row.forEach((cellValue, colIndex) => {
            tableHTML += `<td contenteditable="true" data-row="${rowIndex}" data-col="${colIndex}">${cellValue !== null ? cellValue.toFixed(2) : ''}</td>`;
        });
        tableHTML += `</tr>`;
    });
    tableHTML += `</tbody></table>`;
    editableMapTableContainer.innerHTML = tableHTML;

    // Add event listener for input changes
    editableMapTableContainer.querySelectorAll('td[contenteditable="true"]').forEach(cell => {
        cell.addEventListener('input', function() {
            const row = parseInt(this.dataset.row);
            const col = parseInt(this.dataset.col);
            let newValue = parseFloat(this.innerText);
            if (isNaN(newValue)) {
                newValue = null; // Set to null if not a valid number
            }
            currentMapData[row][col] = newValue;
            // Re-render line plot if active and data changes
            if (mapChartDiv.style.display !== 'none' && linePlotControls.style.display !== 'none') {
                renderLinePlot();
            }
        });
    });
}

// Function to render 2D Line Plot
function renderLinePlot() {
    if (!currentMapData || !currentMapInfo) return;

    // Show Plotly, hide table, show 2D controls
    showElement(mapChartDiv);
    hideElement(editableMapTableContainer);
    showElement(linePlotControls);

    showElement(showSurfacePlotButton); // Now user can switch to surface plot
    showElement(showTableButton);       // Now user can switch to table
    hideElement(showLinePlotButton);    // Hide line plot button when it's already shown

    const plotAxis = linePlotAxisSelect.value;
    const plotIndex = parseInt(linePlotIndexSlider.value);
    currentLinePlotIndexSpan.innerText = plotIndex;

    let xValues = [];
    let yValues = [];
    let title = "";
    let xAxisTitle = "";
    let yAxisTitle = currentMapInfo.unit || "Value";

    if (plotAxis === 'y') { // Plotting a row (Y-axis fixed, X-axis varies)
        if (plotIndex >= 0 && plotIndex < currentMapData.length) {
            yValues = currentMapData[plotIndex];
            xValues = currentMapInfo.x_axis;
            title = `${currentMapInfo.display_name} - ที่ RPM: ${currentMapInfo.y_axis[plotIndex]} ${currentMapInfo.unit || ""}`;
            xAxisTitle = "LOAD";
        } else {
            console.warn("Invalid row index for line plot.");
            yValues = [];
            xValues = [];
            title = "No data for selected row.";
        }
    } else { // Plotting a column (X-axis fixed, Y-axis varies)
        if (plotIndex >= 0 && plotIndex < currentMapData[0].length) {
            yValues = currentMapData.map(row => row[plotIndex]);
            xValues = currentMapInfo.y_axis;
            title = `${currentMapInfo.display_name} - ที่ LOAD: ${currentMapInfo.x_axis[plotIndex]} ${currentMapInfo.unit || ""}`;
            xAxisTitle = "RPM";
        } else {
            console.warn("Invalid column index for line plot.");
            yValues = [];
            xValues = [];
            title = "No data for selected column.";
        }
    }

    Plotly.newPlot("mapChart", [{
      x: xValues,
      y: yValues,
      mode: "lines+markers",
      type: "scatter",
      name: currentMapInfo.display_name,
      line: { color: 'blue' }
    }], {
      title: title,
      xaxis: { title: xAxisTitle },
      yaxis: { title: yAxisTitle },
      autosize: true,
      margin: { l: 50, r: 50, b: 50, t: 50 },
      height: 500
    }, { responsive: true });
}

// Event listeners for switching views
showSurfacePlotButton.addEventListener('click', renderSurfacePlot);
showTableButton.addEventListener('click', renderEditableTable);
showLinePlotButton.addEventListener('click', renderLinePlot); // New event listener

// Event listeners for 2D plot controls
linePlotAxisSelect.addEventListener('change', function() {
    // Update max value of slider based on selected axis
    linePlotIndexSlider.max = (this.value === 'y' ? currentMapData.length : currentMapData[0].length) - 1;
    linePlotIndexSlider.value = 0; // Reset slider
    currentLinePlotIndexSpan.innerText = 0; // Update span
    renderLinePlot();
});

linePlotIndexSlider.addEventListener('input', function() {
    currentLinePlotIndexSpan.innerText = this.value; // Update span
    renderLinePlot(); // Re-render plot on slider change
});


// Function to save (download) the modified bin file
saveMapButton.addEventListener('click', async function() {
    if (!currentBinFile || !currentMapData || !currentMapInfo) {
        alert("❌ ไม่มีข้อมูลแผนที่หรือไฟล์ต้นฉบับที่จะบันทึก");
        return;
    }

    saveMapButton.disabled = true;
    showElement(loadingSpinner);

    const formData = new FormData();
    formData.append("original_bin", currentBinFile); // Send the original file
    formData.append("map_type", currentMapInfo.type); // Which map was edited
    formData.append("modified_map_data", JSON.stringify(currentMapData)); // The edited map data

    try {
        const res = await fetch("https://ecu-backend-m07d.onrender.com/save_tuned_bin", { // New endpoint for saving
            method: "POST",
            body: formData
        });

        if (!res.ok) {
            const errorText = await res.text();
            throw new Error(`HTTP error! status: ${res.status}, body: ${errorText}`);
        }

        const blob = await res.blob(); // Get the response as a blob (binary data)
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${currentMapInfo.type}_tuned_${currentBinFile.name}`; // Suggest a filename
        document.body.appendChild(a);
        a.click();
        a.remove();
        window.URL.revokeObjectURL(url);
        alert("✅ ไฟล์ที่จูนแล้วถูกบันทึกเรียบร้อย!");

    } catch (err) {
        console.error("Save Error:", err);
        alert("❌ เกิดข้อผิดพลาดในการบันทึกไฟล์ที่จูน: " + err.message);
    } finally {
        saveMapButton.disabled = false;
        hideElement(loadingSpinner);
    }
});

// Initial glossary load
showGlossary(document.getElementById("mapType").value);
  </script>
</body>
</html>

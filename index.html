<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>ECU Map Viewer</title>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background-color: #f6f6f6; }
    #mapChart { margin-top: 30px; }
    select, input, button { margin: 5px 0; padding: 8px; font-size: 16px; }
    #glossary { margin-top: 10px; font-style: italic; color: #555; }
  </style>
</head>
<body>
  <h2>ECU Map Analyzer</h2>
  <form id="uploadForm">
    <label for="mapType">เลือกแผนที่:</label>
    <select id="mapType" onchange="showGlossary(this.value)">
      <option value="fuel">Limit IQ (Fuel Map)</option>
      <option value="fuel_quantity">Injector Quantity</option>
      <option value="injection_timing">Injector Timing</option>
      <option value="boost_pressure">Boost Pressure</option>
      <option value="rail_pressure">Rail Pressure (Limit CRP)</option>
      <option value="torque_limiter">Limit Torque</option>
      <option value="drivers_wish">Torque TPS (Driver’s Wish)</option>
      <option value="turbo_duty">Turbo Duty Cycle</option>
      <option value="smoke_limiter">Smoke Limiter</option>
      <option value="iat_ect_correction">IAT & ECT Correction</option>
      <option value="egr">EGR Target</option>
      <option value="throttle">Throttle Valve</option>
      <option value="dtc_off">DTC Table</option>
    </select>
    <br>
    <input type="file" id="binFile" accept=".bin" required />
    <button type="submit">วิเคราะห์แผนที่</button>
  </form>

  <div id="glossary">คำอธิบายแผนที่จะปรากฏที่นี่</div>
  <div id="mapChart"></div>
  <script>
const mapUnits = {
  fuel: "mg/stroke",
  fuel_quantity: "mg/stroke",
  injection_timing: "° BTDC",
  boost_pressure: "mbar",
  rail_pressure: "bar",
  torque_limiter: "%",
  drivers_wish: "%",
  turbo_duty: "%",
  smoke_limiter: "mg/stroke",
  iat_ect_correction: "%",
  egr: "%",
  throttle: "%",
  dtc_off: ""
};

function showGlossary(type) {
  const glossary = {
    fuel: "ควบคุมปริมาณการฉีดน้ำมันต่อรอบ (Limit IQ)",
    fuel_quantity: "ปริมาณการฉีดน้ำมันจริงที่ ECU คำนวณ",
    injection_timing: "เวลาการฉีดน้ำมันก่อนจุดศูนย์ (°BTDC)",
    boost_pressure: "แรงดันอากาศที่เทอร์โบควบคุม (mbar)",
    rail_pressure: "แรงดันน้ำมันในราง Fuel Rail (bar)",
    torque_limiter: "จำกัดแรงบิดสูงสุดในแต่ละสภาวะ",
    drivers_wish: "คำสั่งแรงบิดจากตำแหน่งคันเร่ง",
    turbo_duty: "ระดับสั่งงานวาล์วเทอร์โบหรือ actuator (%)",
    smoke_limiter: "จำกัดการฉีดเมื่อควันสูงเกินไป",
    iat_ect_correction: "ปรับค่าตามอุณหภูมิ Intake และ Coolant",
    egr: "กำหนดสัดส่วนหมุนเวียนไอเสีย",
    throttle: "การเปิด/ปิดลิ้นปีกผีเสื้อตามการควบคุม",
    dtc_off: "แผนที่ปิดการแจ้งเตือนระบบหรือ DTC"
  };
  document.getElementById("glossary").innerText = glossary[type] || "";
}

document.getElementById("uploadForm").addEventListener("submit", function (e) {
  e.preventDefault();
  const fileInput = document.getElementById("binFile");
  const mapType = document.getElementById("mapType").value;
  const file = fileInput.files[0];
  if (!file) return alert("กรุณาเลือกไฟล์ .bin");

  const formData = new FormData();
  formData.append("bin", file);
  formData.append("type", mapType);

  fetch("https://ecu-backend-m07d.onrender.com/analyze", {
  method: "POST",
  body: formData
})
  .then(res => res.json())
  .then(data => {
    if (!data.map || !Array.isArray(data.map)) {
      alert("❌ ไม่พบข้อมูล map หรือรูปแบบผิดพลาด");
      return;
    }

    Plotly.newPlot("mapChart", [{
      z: data.map,
      x: data.x_axis,
      y: data.y_axis,
      type: "surface",
      colorscale: "Jet",
      hovertemplate: `LOAD: %{x}<br>RPM: %{y}<br>ค่า: %{z} ${data.unit}<extra></extra>`
    }], {
      title: `${data.display_name} (${data.unit})`,
      scene: {
        xaxis: { title: "LOAD" },
        yaxis: { title: "RPM" },
        zaxis: { title: data.unit }
      }
    });
  })
  .catch(err => {
    console.error("Error:", err);
    alert("เกิดข้อผิดพลาดในการวิเคราะห์ไฟล์");
  });
});
</script>
</body>
</html>

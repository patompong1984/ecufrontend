<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>ECU Map Analyzer</title>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background-color: #f6f6f6; }
    #mapChart { margin-top: 30px; }
    select, input, button { margin: 5px 0; padding: 8px; font-size: 16px; }
    #glossary { margin-top: 10px; font-style: italic; color: #555; }
  </style>
</head>
<body>
  <h2>ECU Map Analyzer</h2>
  <form id="uploadForm">
    <label for="mapType">เลือกแผนที่:</label>
    <select id="mapType" onchange="showGlossary(this.value)">
      <option value="limit_iq_1">Limit IQ #1</option>
      <option value="limit_iq_2">Limit IQ #2</option>
      <option value="limit_iq_3">Limit IQ #3</option>
      <option value="torque_tps_1">Torque TPS #1</option>
      <option value="torque_tps_2">Torque TPS #2</option>
      <option value="torque_tps_3">Torque TPS #3</option>
      <option value="egr_target">EGR Target</option>
      <option value="pump_command">Pump Command</option>
      <option value="injector_1">Injector #1</option>
      <option value="injector_2">Injector #2</option>
      <option value="limit_baro_1">Limit BARO 1</option>
      <option value="limit_baro_2">Limit BARO 2</option>
      <option value="limit_baro_3">Limit BARO 3</option>
      <option value="limit_torque">Limit Torque</option>
      <option value="torque_gear">Torque Gear</option>
      <option value="limit_crp">Limit CRP</option>
      <option value="green_1">Green Zone #1</option>
      <option value="green_2">Green Zone #2</option>
      <option value="green_3">Green Zone #3</option>
      <option value="green_4">Green Zone #4</option>
      <option value="green_5">Green Zone #5</option>
      <option value="turbo">Turbo Target</option>
      <option value="turbo_meter">Turbo Meter</option>
      <option value="dtc_off">DTC Table</option>
    </select>
    <br>
    <input type="file" id="binFile" accept=".bin" required />
    <button type="submit">วิเคราะห์แผนที่</button>
  </form>

  <div id="glossary">คำอธิบายแผนที่จะปรากฏที่นี่</div>
  <div id="mapChart"></div>
  <script>
function showGlossary(type) {
  const glossary = {
    limit_iq_1: "Limit IQ #1: ปริมาณเชื้อเพลิงต่อรอบที่ ECU จำกัดไว้",
    limit_iq_2: "Limit IQ #2: แมพซ้ำสำหรับสถานการณ์ต่างกัน",
    torque_tps_1: "Torque TPS #1: คำสั่งแรงบิดจากคันเร่ง",
    injector_1: "Injector #1: คำสั่งจำนวนเชื้อเพลิงที่ฉีด",
    limit_crp: "Rail Pressure: แรงดันน้ำมันในรางแรงดันสูง",
    dtc_off: "DTC Table: ปิดการแจ้งเตือนรหัสผิดพลาด",
    // เพิ่มคำอธิบายอื่น ๆ ได้ตามชื่อแมพ
  };
  document.getElementById("glossary").innerText = glossary[type] || "ไม่มีคำอธิบายสำหรับแผนที่นี้";
}

document.getElementById("uploadForm").addEventListener("submit", function (e) {
  e.preventDefault();

  const fileInput = document.getElementById("binFile");
  const mapType = document.getElementById("mapType").value;
  const file = fileInput.files[0];
  if (!file) return alert("❌ กรุณาเลือกไฟล์ .bin");

  // เลือก format ตามแมพ (16bit สำหรับ limit_crp, green zone ฯลฯ)
  const format = mapType.includes("crp") || mapType.includes("green") ? "default_16bit" : "default_8bit";

  const formData = new FormData();
  formData.append("bin", file);
  formData.append("type", mapType);
  formData.append("format", format);

  // ✅ เรียก backend ที่คุณ deploy บน Render
  fetch("https://ecu-backend-m07d.onrender.com/analyze", {
    method: "POST",
    body: formData
  })
  .then(res => res.json())
  .then(data => {
    if (data.error) {
      alert("❌ Backend error: " + data.error);
      console.error("Error:", data.error);
      return;
    }

    if (!data.map || !Array.isArray(data.map)) {
      alert("❌ รูปแบบข้อมูลไม่ถูกต้อง");
      return;
    }

    Plotly.newPlot("mapChart", [{
      z: data.map,
      x: data.x_axis,
      y: data.y_axis,
      type: "surface",
      colorscale: "Jet",
      hovertemplate: `LOAD: %{x}<br>RPM: %{y}<br>ค่า: %{z} ${data.unit || ""}<extra></extra>`
    }], {
      title: `${data.type} (${data.unit || "?"})`,
      scene: {
        xaxis: { title: "LOAD" },
        yaxis: { title: "RPM" },
        zaxis: { title: data.unit || "Value" }
      }
    });
  })
  .catch(err => {
    console.error("Fetch Error:", err);
    alert("เกิดข้อผิดพลาดในการวิเคราะห์ไฟล์");
  });
});
</script>
</body>
</html>

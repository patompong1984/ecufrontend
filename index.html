<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>ECU Map Viewer ‚Äì Multi Maps</title>
  <script src="https://cdn.plot.ly/plotly-2.20.0.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background: #f0f0f0;
    }
    input, select, button {
      margin-top: 10px;
      padding: 10px;
      font-size: 16px;
    }
    #log, #result, #mapChart, #editor {
      margin-top: 10px;
      padding: 10px;
      background: #fff;
      border: 1px solid #ccc;
      white-space: pre-wrap;
    }
    .log-success { color: green; }
    .log-error { color: red; }
    .log-step { color: #333; }
    table { border-collapse: collapse; }
    td { padding: 2px; }
    input[type="number"] {
      width: 60px;
    }
  </style>
</head>
<body>

  <h2>üöó ECU Map Viewer ‚Äì Isuzu D-Max 1.9L</h2>

  <input type="file" id="binFile" accept=".bin,.ori,.hex"><br>

  <label>üóÇÔ∏è ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó Map:</label>
  <select id="mapType" onchange="showGlossary(this.value)">
    <option value="fuel">Fuel</option>
    <option value="torque_limiter">Torque Limiter</option>
    <option value="drivers_wish">Drivers Wish</option>
    <option value="fuel_quantity">Fuel Quantity</option>
    <option value="injection_timing">Injection Timing</option>
    <option value="boost_pressure">Boost Pressure</option>
    <option value="rail_pressure">Rail Pressure</option>
    <option value="turbo_duty">Turbo Duty</option>
    <option value="smoke_limiter">Smoke Limiter</option>
    <option value="iat_ect_correction">IAT & ECT Correction</option>
    <option value="egr">EGR</option>
    <option value="throttle">Throttle</option>
    <option value="dtc_off">DTC Off</option>
  </select>

  <div id="glossary" style="margin-top: 10px; font-style: italic; color: #555;"></div>
  <button onclick="sendFile()">üîç ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå ECU Map</button>

  <div id="log">üìã Log:</div>
  <div id="result">üßæ ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå JSON:</div>
  <div id="mapChart"></div>
  <div id="editor"></div>
  <button onclick="updateChart()">üìà ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Å‡∏£‡∏≤‡∏ü‡∏´‡∏•‡∏±‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
  <script>
    let currentMap = [], xAxis = [], yAxis = [];

    async function sendFile() {
      const file = document.getElementById("binFile").files[0];
      const mapType = document.getElementById("mapType").value;
      const logDiv = document.getElementById("log");
      const resultDiv = document.getElementById("result");
      const chartDiv = document.getElementById("mapChart");
      const editorDiv = document.getElementById("editor");

      logDiv.innerHTML = "üìã Log:\n";
      resultDiv.innerText = "üßæ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå...";
      chartDiv.innerHTML = "";
      editorDiv.innerHTML = "";

      if (!file) {
        log("‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå .BIN", "error");
        return;
      }

      log(`üì§ ‡∏™‡πà‡∏á‡πÑ‡∏ü‡∏•‡πå ${file.name} ‚Üí Map: '${mapType}'`, "step");

      const formData = new FormData();
      formData.append('bin', file);
      formData.append('type', mapType);

      try {
        const res = await fetch("https://ecu-backend-m07d.onrender.com/analyze", {
          method: "POST",
          body: formData
        });

        if (!res.ok) throw new Error("‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏° backend ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");

        const data = await res.json();
        currentMap = data.map;
        xAxis = data.x_axis;
        yAxis = data.y_axis;

        resultDiv.innerText = `‚úÖ ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${data.type} Map\n\n` + JSON.stringify(currentMap, null, 2);

        Plotly.newPlot(chartDiv, [{
          z: currentMap,
          x: xAxis,
          y: yAxis,
          type: 'heatmap',
          colorscale: 'Jet',
          hoverongaps: false
        }], {
          title: `${data.type} Map ‚Äì Offset ${data.offset}`,
          width: 700,
          height: 700,
          margin: { t: 60, l: 60, r: 30, b: 40 },
          xaxis: { title: "‡πÇ‡∏´‡∏•‡∏î (%)", tickfont: { size: 12 } },
          yaxis: { title: "‡∏£‡∏≠‡∏ö‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á (RPM)", tickfont: { size: 12 } },
          font: { family: "Arial", size: 14 }
        });

        log("üìä ‡∏ß‡∏≤‡∏î‡∏Å‡∏£‡∏≤‡∏ü‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", "success");
        renderEditor(currentMap);

      } catch (error) {
        resultDiv.innerText = "‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + error.message;
        log("üî• " + error.message, "error");
      }

      function log(msg, type) {
        const div = document.createElement("div");
        div.innerText = msg;
        div.className = "log-" + type;
        logDiv.appendChild(div);
      }
    }

    function renderEditor(map) {
      const editorDiv = document.getElementById("editor");
      editorDiv.innerHTML = "<h4>üìù ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ñ‡πà‡∏≤ Map:</h4><table border='1'>";
      map.forEach((row, i) => {
        editorDiv.innerHTML += "<tr>" +
          row.map((val, j) => `<td><input type="number" step="0.01" value="${val}" data-i="${i}" data-j="${j}"></td>`).join("") +
          "</tr>";
      });
      editorDiv.innerHTML += "</table>";
    }

    function updateChart() {
      const inputs = document.querySelectorAll("#editor input");
      const updatedMap = Array.from({ length: 16 }, () => Array(16).fill(0));
      inputs.forEach(input => {
        const i = +input.dataset.i;
        const j = +input.dataset.j;
        updatedMap[i][j] = parseFloat(input.value) || 0;
      });

      Plotly.newPlot(document.getElementById("mapChart"), [{
        z: updatedMap,
        x: xAxis,
        y: yAxis,
        type: 'heatmap',
        colorscale: 'Jet',
        hoverongaps: false
      }], {
        title: "üõ† ‡∏Å‡∏£‡∏≤‡∏ü‡∏´‡∏•‡∏±‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç",
        width: 700,
        height: 700,
        margin: { t: 60, l: 60, r: 30, b: 40 },
        xaxis: { title: "‡πÇ‡∏´‡∏•‡∏î (%)", tickfont: { size: 12 } },
        yaxis: { title: "‡∏£‡∏≠‡∏ö‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á (RPM)", tickfont: { size: 12 } },
        font: { family: "Arial", size: 14 }
      });

      document.getElementById("result").innerText = "üõ† ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß\n\n" + JSON.stringify(updatedMap, null, 2);
    }

    function showGlossary(type) {
      const descriptions = {
        fuel: "‡∏â‡∏µ‡∏î‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏£‡πÉ‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏£‡∏≠‡∏ö",
        torque_limiter: "‡∏à‡∏≥‡∏Å‡∏±‡∏î‡πÅ‡∏£‡∏á‡∏ö‡∏¥‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢",
        drivers_wish: "‡πÅ‡∏£‡∏á‡∏ö‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏ú‡∏π‡πâ‡∏Ç‡∏±‡∏ö‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£",
        fuel_quantity: "‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô‡∏à‡∏£‡∏¥‡∏á‡∏ó‡∏µ‡πà‡∏â‡∏µ‡∏î‡πÇ‡∏î‡∏¢ ECU",
        injection_timing: "‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏â‡∏µ‡∏î ‚Üí ‡∏™‡πà‡∏á‡∏ú‡∏•‡∏ï‡πà‡∏≠‡πÅ‡∏£‡∏á/‡πÄ‡∏™‡∏µ‡∏¢‡∏á",
        boost_pressure: "‡πÅ‡∏£‡∏á‡∏î‡∏±‡∏ô‡∏à‡∏≤‡∏Å‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÇ‡∏ö ‚Üí ‡πÄ‡∏£‡πà‡∏á‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á",
        rail_pressure: "‡πÅ‡∏£‡∏á‡∏î‡∏±‡∏ô‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô‡πÉ‡∏ô‡∏£‡∏≤‡∏á common rail",
        turbo_duty: "‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏™‡∏±‡πà‡∏á‡∏á‡∏≤‡∏ô turbo actuator",
        smoke_limiter: "‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏â‡∏µ‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏∏‡∏°‡∏Ñ‡∏ß‡∏±‡∏ô‡∏î‡∏≥",
        iat_ect_correction: "‡∏õ‡∏£‡∏±‡∏ö‡∏ï‡∏≤‡∏°‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥‡πÑ‡∏≠‡∏î‡∏µ + ‡∏ô‡πâ‡∏≥‡∏´‡∏•‡πà‡∏≠‡πÄ‡∏¢‡πá‡∏ô",
        egr: "‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏£‡∏∞‡∏ö‡∏ö EGR ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏´‡∏°‡∏∏‡∏ô‡πÑ‡∏≠‡πÄ‡∏™‡∏µ‡∏¢",
        throttle: "‡∏•‡∏¥‡πâ‡∏ô‡∏õ‡∏µ‡∏Å‡∏ú‡∏µ‡πÄ‡∏™‡∏∑‡πâ‡∏≠‡∏ï‡∏≤‡∏°‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏¢‡∏ô‡∏ï‡πå",
        dtc_off: "‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏õ‡∏¥‡∏î‡πÑ‡∏ü‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô DTC"
      };
      document.getElementById("glossary").innerText = descriptions[type] || "";
    }
  </script>
</body>
</html>

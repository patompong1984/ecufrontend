<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>ECU Map Viewer ‚Äì Multi Maps</title>
  <script src="https://cdn.plot.ly/plotly-2.20.0.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background: #f0f0f0;
    }
    input, select, button {
      margin-top: 10px;
      padding: 10px;
      font-size: 16px;
    }
    #log, #result, #mapChart, #editor {
      margin-top: 10px;
      padding: 10px;
      background: #fff;
      border: 1px solid #ccc;
      white-space: pre-wrap;
    }
    .log-success { color: green; }
    .log-error { color: red; }
    .log-step { color: #333; }
    table { border-collapse: collapse; }
    td { padding: 2px; }
    input[type="number"] {
      width: 60px;
    }
  </style>
</head>
<body>

  <h2>üöó Isuzu D-Max 1.9 ECU Viewer (Multi-Map)</h2>

  <input type="file" id="binFile" accept=".bin,.ori,.hex"><br>

  <label>üóÇÔ∏è ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó Map:</label>
<!-- ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡πÉ‡∏ï‡πâ dropdown -->
<div id="glossary" style="margin-top: 10px; font-style: italic; color: #555;"></div>

<!-- ‡∏õ‡∏£‡∏±‡∏ö select ‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢ -->
<select id="mapType" onchange="showGlossary(this.value)">
  <option value="fuel">Fuel</option>
  <option value="torque_limiter">Torque Limiter Map</option>
  <option value="drivers_wish">Driver‚Äôs Wish Map</option>
  <option value="fuel_quantity">Fuel Quantity Map</option>
  <option value="injection_timing">Injection Timing Map</option>
  <option value="boost_pressure">Boost Pressure Map</option>
  <option value="rail_pressure">Rail Pressure Map</option>
  <option value="turbo_duty">Turbo Duty Cycle Map</option>
  <option value="smoke_limiter">Smoke Limiter Map</option>
  <option value="iat_ect_correction">IAT & ECT Correction Maps</option>
  <option value="egr">EGR Map</option>
  <option value="throttle">Throttle Valve Map</option>
  <option value="dtc_off">DTC Off Table</option>
</select><br>
  <button onclick="sendFile()">üîç ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå ECU Map</button>

  <div id="log">üìã Log ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô:</div>
  <div id="result">üßæ ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå JSON:</div>
  <div id="mapChart"></div>
  <div id="editor"></div>
  <button onclick="updateChart()">üìà ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Å‡∏£‡∏≤‡∏ü‡∏´‡∏•‡∏±‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>

  <script>
    let currentMap = [];
    let chartDiv = document.getElementById("mapChart");
    let resultDiv = document.getElementById("result");

    async function sendFile() {
      const fileInput = document.getElementById("binFile");
      const mapType = document.getElementById("mapType").value;
      const file = fileInput.files[0];
      const logDiv = document.getElementById("log");
      const editorDiv = document.getElementById("editor");

      logDiv.innerHTML = "üìã Log ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô:\n";
      resultDiv.innerText = "üßæ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå...";
      chartDiv.innerHTML = "";
      editorDiv.innerHTML = "";

      if (!file) {
        log("‚ùå ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå", "error");
        alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö");
        return;
      }

      log(`üì§ ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏™‡πà‡∏á‡πÑ‡∏ü‡∏•‡πå ${file.name} ‡∏î‡πâ‡∏ß‡∏¢‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó '${mapType}'`, "step");

      const formData = new FormData();
      formData.append('bin', file);
      formData.append('type', mapType);

      try {
        log("üöÄ ‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏¢‡∏±‡∏á backend...", "step");

        const res = await fetch("https://ecu-backend-m07d.onrender.com/analyze", {
          method: "POST",
          body: formData
        });

        if (!res.ok) throw new Error("‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏°‡πà‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö: " + res.status);

        const data = await res.json();
        log("‚úÖ backend ‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢", "success");

        resultDiv.innerText = `‚úÖ ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${data.type} Map\n\n` + JSON.stringify(data.map, null, 2);
        currentMap = data.map;

        Plotly.newPlot(chartDiv, [{
          z: currentMap,
          type: 'heatmap',
          colorscale: 'YlGnBu'
        }], {
          title: `${data.type} Map ‚Äì Offset ${data.offset}`,
          margin: { t: 40 }
        });

        log("üìä ‡∏ß‡∏≤‡∏î‡∏Å‡∏£‡∏≤‡∏ü‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", "success");
        renderEditor(currentMap);

      } catch (error) {
        resultDiv.innerText = "‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + error.message;
        log("üî• Error: " + error.message, "error");
      }

      function log(msg, type) {
        const span = document.createElement("div");
        span.innerText = msg;
        span.className = "log-" + type;
        logDiv.appendChild(span);
      }
    }

    function renderEditor(map) {
      const editorDiv = document.getElementById("editor");
      editorDiv.innerHTML = "<h4>üìù ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ñ‡πà‡∏≤ Map:</h4><table border='1'>";
      map.forEach((row, i) => {
        editorDiv.innerHTML += "<tr>" +
          row.map((val, j) => `<td><input type="number" step="0.01" value="${val}" data-i="${i}" data-j="${j}"></td>`).join("") +
          "</tr>";
      });
      editorDiv.innerHTML += "</table>";
    }

    function updateChart() {
      const inputs = document.querySelectorAll("#editor input");
      const updatedMap = Array.from({ length: 16 }, () => Array(16).fill(0));
      inputs.forEach(input => {
        const i = +input.dataset.i;
        const j = +input.dataset.j;
        updatedMap[i][j] = parseFloat(input.value) || 0;
      });

      Plotly.newPlot(chartDiv, [{
        z: updatedMap,
        type: 'heatmap',
        colorscale: 'YlGnBu'
      }], {
        title: "üõ† ‡∏Å‡∏£‡∏≤‡∏ü‡∏´‡∏•‡∏±‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç",
        margin: { t: 40 }
      });

      resultDiv.innerText = "üõ† ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß\n\n" + JSON.stringify(updatedMap, null, 2);
    }
    function showGlossary(type) {
  const descriptions = {
    fuel: "‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏ß‡πà‡∏≤‡∏â‡∏µ‡∏î‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏£‡πÉ‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏£‡∏≠‡∏ö‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏¢‡∏ô‡∏ï‡πå",
    torque_limiter: "‡∏à‡∏≥‡∏Å‡∏±‡∏î‡πÅ‡∏£‡∏á‡∏ö‡∏¥‡∏î‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡πÉ‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏û‡∏±‡∏á",
    drivers_wish: "‡πÅ‡∏õ‡∏£‡∏ú‡∏±‡∏ô‡∏à‡∏≤‡∏Å‡∏Ñ‡∏±‡∏ô‡πÄ‡∏£‡πà‡∏á ‚Üí ECU ‡∏ï‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ß‡πà‡∏≤ '‡∏ú‡∏π‡πâ‡∏Ç‡∏±‡∏ö‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏£‡∏á‡πÅ‡∏Ñ‡πà‡πÑ‡∏´‡∏ô'",
    fuel_quantity: "‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏ß‡πà‡∏≤‡∏â‡∏µ‡∏î‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô‡∏à‡∏£‡∏¥‡∏á‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏£‡∏ï‡∏≤‡∏°‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ç‡∏≠‡∏á ECU",
    injection_timing: "‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏´‡∏±‡∏ß‡∏â‡∏µ‡∏î‡∏û‡πà‡∏ô‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô ‚Üí ‡∏™‡πà‡∏á‡∏ú‡∏•‡∏ï‡πà‡∏≠‡πÅ‡∏£‡∏á‡∏ö‡∏¥‡∏î‡πÅ‡∏•‡∏∞‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á",
    boost_pressure: "‡πÅ‡∏£‡∏á‡∏î‡∏±‡∏ô‡∏à‡∏≤‡∏Å‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÇ‡∏ö ‚Üí ‡πÉ‡∏ä‡πâ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏£‡∏á‡∏ö‡∏¥‡∏î‡∏Ç‡∏ì‡∏∞‡πÄ‡∏£‡πà‡∏á",
    rail_pressure: "‡πÅ‡∏£‡∏á‡∏î‡∏±‡∏ô‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô‡πÉ‡∏ô‡∏£‡∏≤‡∏á ‚Üí ‡∏™‡πà‡∏á‡∏ú‡∏•‡∏ï‡πà‡∏≠‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏â‡∏µ‡∏î‡πÅ‡∏•‡∏∞‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡∏à‡πà‡∏≤‡∏¢",
    turbo_duty: "‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏ß‡∏≤‡∏•‡πå‡∏ß‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÇ‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏π‡∏™‡∏ï‡πå",
    smoke_limiter: "‡∏•‡∏î‡∏Å‡∏≤‡∏£‡∏â‡∏µ‡∏î‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô‡∏´‡∏≤‡∏Å‡∏Ñ‡∏ß‡∏±‡∏ô‡∏°‡∏≤‡∏Å‡πÄ‡∏Å‡∏¥‡∏ô ‚Üí ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡πÑ‡∏≠‡πÄ‡∏™‡∏µ‡∏¢‡∏î‡∏≥",
    iat_ect_correction: "‡∏õ‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥‡πÑ‡∏≠‡∏î‡∏µ‡πÅ‡∏•‡∏∞‡∏ô‡πâ‡∏≥‡∏´‡∏•‡πà‡∏≠‡πÄ‡∏¢‡πá‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢",
    egr: "‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏≠‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏°‡∏∏‡∏ô‡πÄ‡∏ß‡∏µ‡∏¢‡∏ô (EGR) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏î NOx",
    throttle: "‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏•‡∏¥‡πâ‡∏ô‡∏õ‡∏µ‡∏Å‡∏ú‡∏µ‡πÄ‡∏™‡∏∑‡πâ‡∏≠‡∏ï‡∏≤‡∏°‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß",
    dtc_off: "‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏õ‡∏¥‡∏î‡∏£‡∏´‡∏±‡∏™‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î (DTC) ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏±‡∏ö ECU ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏ã‡∏ô‡πÄ‡∏ã‡∏≠‡∏£‡πå"
  };
  document.getElementById("glossary").innerText = descriptions[type] || "";
    }
  </script>
</body>
</html>

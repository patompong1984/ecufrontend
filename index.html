<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>ECU Map Viewer ‚Äì Isuzu 1.9</title>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <style>
    body {
      font-family: Arial;
      padding: 20px;
      background-color: #f0f0f0;
    }
    #result, #mapChart, #log {
      background: #fff;
      padding: 10px;
      border: 1px solid #ccc;
      margin-top: 10px;
      white-space: pre-wrap;
    }
    input, button {
      margin-top: 10px;
      padding: 10px;
      font-size: 16px;
    }
    .log-success { color: green; }
    .log-error { color: red; }
    .log-step { color: #333; }
  </style>
</head>
<body>

  <h2>üöó Isuzu D-Max 1.9 ECU Viewer</h2>

  <input type="file" id="binFile" accept=".bin,.ori,.hex" />
  <br/>
  <button onclick="sendFile()">üîç ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÑ‡∏ü‡∏•‡πå ECU</button>

  <div id="log">üìã Log ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô:</div>
  <div id="result">üßæ ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå JSON: ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>
  <div id="mapChart"></div>

  <script>
    async function sendFile() {
      const input = document.getElementById('binFile');
      const file = input.files[0];
      const logDiv = document.getElementById("log");
      const resultDiv = document.getElementById("result");
      const chartDiv = document.getElementById("mapChart");

      // Reset
      logDiv.innerHTML = "üìã Log ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô:\n";
      resultDiv.innerText = "üßæ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå...";
      chartDiv.innerHTML = "";

      if (!file) {
        log("‚ùå ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå", "error");
        alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö");
        return;
      }

      log("üì§ ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏™‡πà‡∏á‡πÑ‡∏ü‡∏•‡πå: " + file.name, "step");

      const formData = new FormData();
      formData.append('bin', file);

      try {
        log("üöÄ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏¢‡∏±‡∏á backend...", "step");

        const res = await fetch("https://ecu-backend-m07d.onrender.com/analyze", {
          method: "POST",
          body: formData
        });

        if (!res.ok) {
          throw new Error("‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏°‡πà‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö (" + res.status + ")");
        }

        log("‚úÖ backend ‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß", "success");

        const data = await res.json();

        resultDiv.innerText = "üßæ ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:\n\n" + JSON.stringify(data.map, null, 2);
        log("üìä ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏£‡∏≤‡∏ü 2D ‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•", "step");

        Plotly.newPlot(chartDiv, [{
          z: data.map,
          type: 'heatmap',
          colorscale: 'YlGnBu'
        }], {
          title: 'Fuel Map ‚Äì Isuzu D-Max 1.9',
          margin: { t: 40 }
        });

        log("‚úÖ ‡∏ß‡∏≤‡∏î‡∏Å‡∏£‡∏≤‡∏ü‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", "success");

      } catch (error) {
        resultDiv.innerText = "‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + error.message;
        log("üî• Error: " + error.message, "error");
      }

      function log(message, type) {
        const span = document.createElement("div");
        span.innerText = message;
        span.className = "log-" + type;
        logDiv.appendChild(span);
      }
    }
  </script>

</body>
</html>
